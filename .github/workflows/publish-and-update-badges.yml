name: Update NuGet Download Badges

on:
  release:
    types: [created]

permissions:
  contents: write  # ‚úÖ Required for git-auto-commit-action to push changes

jobs:
  update-badges:
    runs-on: windows-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ‚úÖ Needed for committing changes

      # 2Ô∏è‚É£ List all files for debugging
      - name: List files
        run: Get-ChildItem -Recurse

      # 3Ô∏è‚É£ Setup .NET 8
      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      # 4Ô∏è‚É£ Find the .csproj dynamically
      - name: Find .csproj file
        id: findcsproj
        shell: pwsh
        run: |
          $proj = Get-ChildItem -Recurse -Filter *.csproj | Select-Object -First 1
          Write-Output "CSProjPath=$($proj.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      # 5Ô∏è‚É£ Restore dependencies
      - name: Restore dependencies
        run: dotnet restore ${{ steps.findcsproj.outputs.CSProjPath }}

      # 6Ô∏è‚É£ Build project
      - name: Build project
        run: dotnet build ${{ steps.findcsproj.outputs.CSProjPath }} -c Release

      # 7Ô∏è‚É£ Pack NuGet package
      - name: Pack NuGet package
        shell: pwsh
        run: |
          $outDir = Join-Path $PWD "nupkg"
          dotnet pack ${{ steps.findcsproj.outputs.CSProjPath }} -c Release -o $outDir
          Write-Output "Package output folder: $outDir"

      # 8Ô∏è‚É£ Update README badges
      - name: Update README badges
        shell: pwsh
        run: |
          choco install jq -y
          $packages = @(
            "mysqloptimizer","myotpgenerator","customlog","myipaddress",
            "mylogicallibrary","solidprinciplesdemo","designpatternsdemo",
            "autodoccommenter","codesnip.net","realtimetoolkit.net"
          )

          foreach ($pkg in $packages) {
              $downloads = 0
              try {
                  $json = Invoke-RestMethod -Uri "https://api.nuget.org/v3/registration5-semver1/$pkg/index.json"
                  $downloads = ($json.items.catalogEntry.downloadCount | Measure-Object -Sum).Sum
              } catch {
                  Write-Warning "Package $pkg not found or not yet available on NuGet"
              }

              (Get-Content README.md) -replace "https://img.shields.io/nuget/dt/$pkg.*","https://img.shields.io/badge/$pkg-$downloads-blue?style=for-the-badge" | Set-Content README.md
          }

      # 9Ô∏è‚É£ Commit README changes
      - name: Commit README changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update NuGet download badges"
          branch: master  # üîÅ Change to 'main' if your repo‚Äôs default branch is main
