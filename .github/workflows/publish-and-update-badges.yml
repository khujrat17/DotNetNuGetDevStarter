name: Publish NuGet Tool & Update Badges

on:
  release:
    types: [created]

jobs:
  build-pack-publish:
    runs-on: windows-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - uses: actions/checkout@v4

      # 2Ô∏è‚É£ List all files for debugging
      - name: List files
        run: Get-ChildItem -Recurse

      # 3Ô∏è‚É£ Setup .NET 8
      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      # 4Ô∏è‚É£ Find the .csproj dynamically (PowerShell)
      - name: Find .csproj file
        id: findcsproj
        shell: pwsh
        run: |
          $proj = Get-ChildItem -Recurse -Filter *.csproj | Select-Object -First 1
          Write-Output "CSProjPath=$($proj.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      # 5Ô∏è‚É£ Restore dependencies
      - name: Restore dependencies
        run: dotnet restore ${{ steps.findcsproj.outputs.CSProjPath }}

      # 6Ô∏è‚É£ Build project
      - name: Build project
        run: dotnet build ${{ steps.findcsproj.outputs.CSProjPath }} -c Release

      # 7Ô∏è‚É£ Pack NuGet package
      - name: Pack NuGet package
        shell: pwsh
        run: |
          $nuspec = ${{ steps.findcsproj.outputs.CSProjPath }} -replace '\.csproj$', '.nuspec'
          nuget pack $nuspec -Properties Configuration=Release

      # 8Ô∏è‚É£ Push to NuGet.org
      - name: Push to NuGet.org
        shell: pwsh
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          $nupkg = ${{ steps.findcsproj.outputs.CSProjPath }} -replace '\.csproj$', '.1.0.0.nupkg'
          dotnet nuget push $nupkg -k $env:NUGET_API_KEY -s https://api.nuget.org/v3/index.json

      # 9Ô∏è‚É£ Update README badges
      - name: Update README badges
        shell: pwsh
        run: |
          choco install jq -y
          $packages = @("MySqlOptimizer","myOtpGenerator","CustomLog","MyIpAddress","MyLogicalLibrary","SolidPrinciplesDemo","DesignPatternsDemo","AutoDocCommenter","CodeSnip.NET","RealTimeToolkit.NET")
          foreach ($pkg in $packages) {
            $downloads = (Invoke-RestMethod -Uri "https://api.nuget.org/v3/registration5-semver1/$pkg/index.json").items.catalogEntry.downloadCount | Measure-Object -Sum | Select-Object -ExpandProperty Sum
            (Get-Content README.md) -replace "https://img.shields.io/nuget/dt/$pkg.*","https://img.shields.io/badge/$pkg-$downloads-blue?style=for-the-badge" | Set-Content README.md
          }

      # üîü Commit README changes
      - name: Commit README changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update NuGet download badges"
          branch: main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
